using R2Library.Data.ADO.R2.DataServices;
using R2Utilities.Infrastructure.Settings;

namespace R2Utilities.DataAccess;

public class WebStatisticsService : DataServiceBase
{
	private const string GetActiveInstitutionsForStatistics = "\r\nselect iInstitutionId, isnull(MAX(DATEADD(mm, 1, im.aggregationDate)), DATEFROMPARTS(year(i.dtCreationDate), month(i.dtCreationDate), 1)) as 'AggregationDate'\r\nfrom tInstitution i\r\nleft join {0}..InstitutionMonthlyStatisticsCount im on i.iInstitutionId = im.InstitutionId\r\nwhere  i.iInstitutionAcctStatusId = 1 and im.InstitutionMonthlyStatisticsCountId is null or\r\n(\r\n\taggregationDate < @CurrentFormatedDate and iInstitutionId not in \r\n\t(\r\n\t\tselect institutionId from {0}..InstitutionMonthlyStatisticsCount \r\n\t\twhere DATEADD(mm, 1, aggregationDate) = DATEFROMPARTS(year(getdate()), month(getdate()), 1)\r\n\t)\r\n)\r\ngroup by i.iInstitutionId, i.dtCreationDate\r\n";

	private const string GetStatisticsForInstitution = "\r\n\r\nselect MostAccessedResourceId, MostAccessedCount, LeastAccessedResourceId, LeastAccessedCount\r\n, MostTurnawayConcurrentResourceId, MostTurnawayConcurrentCount, MostTurnawayAccessResourceId, MostTurnawayAccessCount,\r\nMostPopularSpecialtyName, MostPopularSpecialtyCount, LeastPopularSpecialtyName, LeastPopularSpecialtyCount, TotalResourceCount\r\nfrom\r\n(select top 1 * from (\r\nselect top 1 resourceId  as 'MostAccessedResourceId', sum(contentviewcount) as 'MostAccessedCount'\r\nfrom [dbo].[vDailyContentViewCount] \r\nwhere institutionId = @InstitutionId and contentViewDate between @StartDate and @EndDate\r\ngroup by resourceId\r\norder by 2 desc\r\nunion select null, null) x order by 2 desc) a, \r\n\r\n(select top 1 * from (\r\nselect top 1 irl.iResourceId  as 'LeastAccessedResourceId', sum(isnull(dcvc.contentviewcount, 0)) as 'LeastAccessedCount'\r\nfrom tInstitutionResourceLicense irl\r\nleft join vDailyContentViewCount dcvc on irl.iInstitutionId = dcvc.institutionId and irl.iResourceId = dcvc.resourceId\r\nwhere irl.iInstitutionId = @InstitutionId and \r\n (contentViewDate between @StartDate and @EndDate )  and isnull(dcvc.contentviewcount, 0) > 0\r\ngroup by irl.iResourceId\r\norder by 2 asc\r\nunion select null, null ) x order by 2 desc) b,\r\n\r\n(select top 1 * from (\r\nselect top 1 resourceId as 'MostTurnawayConcurrentResourceId', sum(contentTurnawayCount) as 'MostTurnawayConcurrentCount'\r\n from vDailyContentTurnawayCount\r\nwhere institutionId = @InstitutionId and contentTurnawayDate between @StartDate and @EndDate\r\nand turnawayTypeId = 20\r\ngroup by resourceId\r\norder by 2 desc\r\nunion select null, null) x order by 2 desc) c,\r\n\r\n(select top 1 * from (\r\nselect top 1 resourceId as 'MostTurnawayAccessResourceId', sum(contentTurnawayCount) as 'MostTurnawayAccessCount'\r\n from vDailyContentTurnawayCount\r\nwhere institutionId = @InstitutionId and contentTurnawayDate between @StartDate and @EndDate\r\nand turnawayTypeId = 21\r\ngroup by resourceId\r\norder by 2 desc\r\nunion select null, null) x order by 2 desc) cc,\r\n\r\n(select top 1 * from (\r\nselect top 1 s.vchSpecialtyName as 'MostPopularSpecialtyName', sum(dcvc.contentViewCount) as 'MostPopularSpecialtyCount'\r\nfrom tResourceSpecialty rs\r\njoin tSpecialty s on rs.iSpecialtyId = s.iSpecialtyId\r\njoin tResource r on rs.iResourceId = r.iResourceId\r\njoin vDailyContentViewCount dcvc on r.iResourceId = dcvc.resourceId\r\nwhere rs.tiRecordStatus = 1 and s.tiRecordStatus = 1 and r.tiRecordStatus = 1\r\nand dcvc.institutionId = @InstitutionId and dcvc.contentViewDate between @StartDate and @EndDate\r\ngroup by rs.iResourceSpecialtyId, s.vchSpecialtyName, dcvc.institutionId\r\norder by 2 desc\r\nunion select null, null) x order by 2 desc) d,\r\n\r\n(select top 1 * from (\r\nselect top 1  s.vchSpecialtyName as 'LeastPopularSpecialtyName', sum(dcvc.contentViewCount) as 'LeastPopularSpecialtyCount'\r\nfrom tResourceSpecialty rs\r\njoin tSpecialty s on rs.iSpecialtyId = s.iSpecialtyId\r\njoin tResource r on rs.iResourceId = r.iResourceId\r\njoin vDailyContentViewCount dcvc on r.iResourceId = dcvc.resourceId\r\nwhere rs.tiRecordStatus = 1 and s.tiRecordStatus = 1 and r.tiRecordStatus = 1 and isnull(dcvc.contentViewCount, 0) > 0\r\nand dcvc.institutionId = @InstitutionId and dcvc.contentViewDate between @StartDate and @EndDate\r\ngroup by rs.iResourceSpecialtyId, s.vchSpecialtyName, dcvc.institutionId\r\nunion select null, null) x order by 2 desc) e,\r\n\r\n(select top 1 * from (\r\nselect count(*) as 'TotalResourceCount'\r\nfrom tInstitutionResourceLicense irl\r\nwhere irl.dtFirstPurchaseDate < @Plus1Month\r\nand irl.iInstitutionId = @InstitutionId and tiRecordStatus = 1\r\nunion select null) x order by 1 desc) f\r\n";

	private const string GetResourceStatisticsForInstitution = "\r\nselect \r\n--@@@@@@@@@@@@@@@@Successful Content Retreival@@@@@@@@@@@@@@@@\r\n(select sum(dcvc.contentViewCount)\r\nfrom   vDailyContentViewCount dcvc\r\nleft outer join tInstitution i on i.iInstitutionId = dcvc.institutionId\r\nwhere dcvc.contentViewDate between @StartDate and @EndDate\r\nand dcvc.institutionId = @InstitutionId) as 'ContentCount',\r\n--@@@@@@@@@@@@@@@@TOC Retrievals@@@@@@@@@@@@@@@@\r\n(select sum(dcvc.contentViewCount)\r\nfrom   vDailyContentViewCount dcvc\r\nleft outer join tInstitution i on i.iInstitutionId = dcvc.institutionId\r\nwhere dcvc.contentViewDate between @StartDate and @EndDate\r\nand dcvc.institutionId = @InstitutionId and dcvc.chapterSectionId is null) as 'TocCount',\r\n--@@@@@@@@@@@@@@@@Sessions@@@@@@@@@@@@@@@@\r\n(select sum(dpvc.sessionCount) \r\nfrom   vDailySessionCount dpvc\r\nleft outer join tInstitution i on i.iInstitutionId = dpvc.institutionId\r\nwhere dpvc.sessionDate between @StartDate and @EndDate\r\nand dpvc.institutionId = @InstitutionId) as 'SessionCount',\r\n--@@@@@@@@@@@@@@@@Print Requests@@@@@@@@@@@@@@@@\r\n(select sum(dcvc.contentViewCount)\r\nfrom   vDailyContentViewCount dcvc \r\nleft outer join tInstitution i on i.iInstitutionId = dcvc.institutionId \r\nwhere dcvc.contentViewDate between @StartDate and @EndDate\r\nand dcvc.institutionId = @InstitutionId and dcvc.actionTypeId = 16) as 'PrintCount',\r\n--@@@@@@@@@@@@@@@@Email Requests@@@@@@@@@@@@@@@@\r\n(select sum(dcvc.contentViewCount)\r\nfrom   vDailyContentViewCount dcvc \r\nleft outer join tInstitution i on i.iInstitutionId = dcvc.institutionId \r\nwhere dcvc.contentViewDate between @StartDate and @EndDate \r\nand dcvc.institutionId = @InstitutionId and dcvc.actionTypeId = 16) as 'EmailCount',\r\n--@@@@@@@@@@@@@@@@Content Turnaways@@@@@@@@@@@@@@@@\r\n(select sum(dctc.contentTurnawayCount)\r\nfrom   vDailyContentTurnawayCount dctc\r\nleft outer join tInstitution i on i.iInstitutionId = dctc.institutionId\r\nwhere dctc.contentTurnawayDate between @StartDate and @EndDate\r\nand dctc.institutionId = @InstitutionId and dctc.TurnawayTypeId = 20) as 'TurnawayConcurrencyCount',\r\n--@@@@@@@@@@@@@@@@Access Turnaways@@@@@@@@@@@@@@@@\r\n(select sum(dctc.contentTurnawayCount)\r\nfrom   vDailyContentTurnawayCount dctc\r\nleft outer join tInstitution i on i.iInstitutionId = dctc.institutionId\r\nwhere dctc.contentTurnawayDate between @StartDate and @EndDate\r\nand dctc.institutionId = @InstitutionId and dctc.TurnawayTypeId = 21) as 'TurnawayAccessCount';\r\n";

	private readonly IR2UtilitiesSettings _r2UtilitiesSettings;

	public WebStatisticsService(IR2UtilitiesSettings r2UtilitiesSettings)
	{
		_r2UtilitiesSettings = r2UtilitiesSettings;
	}
}
